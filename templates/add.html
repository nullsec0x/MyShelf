{% extends "base.html" %}
{% block title %}Add New Book{% endblock %}

{% block content %}
<h1 class="mb-4">Add New Book</h1>

<form method="POST">
    <div class="row mb-3">
        <div class="col-md-8">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" required>
        </div>
        <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button type="button" id="search-btn" class="btn btn-outline-secondary w-100">
                <i class="bi bi-search"></i> Search Google Books
            </button>
        </div>
    </div>

    <div class="mb-3">
        <label for="author" class="form-label">Author</label>
        <input type="text" class="form-control" id="author" name="author" required>
    </div>

    <div class="mb-3">
        <label for="genre" class="form-label">Genre</label>
        <input type="text" class="form-control" id="genre" name="genre" required>
    </div>

    <div class="mb-3">
        <label for="cover_url" class="form-label">Book Cover URL</label>
        <input type="url" class="form-control" id="cover_url" name="cover_url" placeholder="Will be auto-filled from Google Books">
    </div>

    <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
    </div>

    <button type="submit" class="btn btn-primary">Add Book</button>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Cancel</a>
</form>

<div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Google Books</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="search-query" class="form-control" placeholder="Enter book title">
                    <button class="btn btn-primary" id="search-api">Search</button>
                </div>
                <div id="search-results" class="list-group"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('search-btn');
    const searchModal = new bootstrap.Modal(document.getElementById('searchModal'));
    const searchApiBtn = document.getElementById('search-api');
    const searchResults = document.getElementById('search-results');
    
    searchBtn.addEventListener('click', function() {
        searchModal.show();
    });
    
    searchApiBtn.addEventListener('click', function() {
        const query = document.getElementById('search-query').value.trim();
        if (!query) return;
        
        fetch(`/search_books?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    searchResults.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                if (data.results.length === 0) {
                    searchResults.innerHTML = '<div class="alert alert-info">No results found</div>';
                    return;
                }
                
                let html = '';
                data.results.forEach(book => {
                    const coverImg = book.coverUrl ? 
                        `<img src="${book.coverUrl}" alt="Book cover" style="width: 50px; height: auto; margin-right: 10px;">` : 
                        '<div style="width: 50px; height: 75px; background-color: #eee; display: inline-block; margin-right: 10px;"></div>';
                    
                    html += `
                        <a href="#" class="list-group-item list-group-item-action" 
                           data-title="${book.title}" 
                           data-author="${book.author}" 
                           data-genre="${book.genre}" 
                           data-description="${book.description}"
                           data-cover-url="${book.coverUrl}">
                            <div class="d-flex align-items-center">
                                ${coverImg}
                                <div>
                                    <h5 class="mb-1">${book.title}</h5>
                                    <p class="mb-1">${book.author}</p>
                                    <small>${book.genre}</small>
                                </div>
                            </div>
                        </a>
                    `;
                });
                searchResults.innerHTML = html;
                
                document.querySelectorAll('#search-results a').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        document.getElementById('title').value = this.dataset.title;
                        document.getElementById('author').value = this.dataset.author;
                        document.getElementById('genre').value = this.dataset.genre;
                        document.getElementById('description').value = this.dataset.description;
                        document.getElementById('cover_url').value = this.dataset.coverUrl;
                        searchModal.hide();
                        document.body.classList.remove('modal-open');
                        document.querySelector('.modal-backdrop').remove();
                    });
                });
            })
            .catch(error => {
                searchResults.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
    });
});
</script>
{% endblock %}
{% endblock %}
